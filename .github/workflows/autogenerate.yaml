name: Autogenerate files

"on":
  pull_request:
    branches:
      - main

jobs:
  autogenerate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          # Check out the actual PR branch instead of a detached HEAD merge commit.
          # This allows us to push commits back to the branch.
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          submodules: true

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Create virtual environment
        run: |
          make .venv

      - name: Run generator
        run: |
          source .venv/bin/activate
          devtool gen --all

      - name: Check for changes
        run: |
          if ! git diff --quiet; then
            echo "HAS_CHANGES=true" >> "$GITHUB_ENV"
          else
            echo "HAS_CHANGES=false" >> "$GITHUB_ENV"
          fi

      - name: Check if PR author is Renovate
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          if [[ "$PR_AUTHOR" == *renovate* ]]; then
            echo "IS_RENOVATE=true" >> "$GITHUB_ENV"
          else
            echo "IS_RENOVATE=false" >> "$GITHUB_ENV"
          fi

      - name: Commit and push changes (Renovate only)
        if: env.HAS_CHANGES == 'true' && env.IS_RENOVATE == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          git commit -m $'Update generated files\n\nUsing `devtool gen --all`'
          git push

      - name: Show changes and fail (non-Renovate)
        if: env.HAS_CHANGES == 'true' && env.IS_RENOVATE == 'false'
        run: |
          echo "::error::Generated files are out of date"
          echo ""
          echo "Please run locally:"
          echo "  make venv"
          echo "  source .venv/bin/activate"
          echo "  devtool gen --all"
          echo ""
          echo "Changes detected:"
          git diff --color
          exit 1
